<div class="contenedor">
  <div class="contenedor-formulario">
    <h1 class="titulo-pagina">
      <i class="fas fa-cash-register"></i> Nueva Venta
    </h1>

    <!-- Buscador ded productos -->
    <div class="seccion-agregar-producto formulario-grid">
      <div class="grupo-formulario">
        <label class="etiqueta-formulario">Producto:</label>
        <select class="campo-formulario" [(ngModel)]="productoSeleccionadoId">
          <option [ngValue]="null">Seleccione Producto...</option>
          <option *ngFor="let p of listaProductos" [value]="p.id">
            {{ p.nombre }} - ${{ p.precio_final || p.precio_neto }} (Stock: {{p.stock}})
          </option>
        </select>
      </div>

      <div class="grupo-formulario">
        <label class="etiqueta-formulario">Cantidad:</label>
        <input type="number" class="campo-formulario" [(ngModel)]="cantidadInput" min="1" placeholder="1">
      </div>

      <div class="contenedor-botones-vertical">
        <button class="boton boton-secundario boton-con-icono" (click)="agregarProductoALista()">
          <i class="fas fa-plus"></i> Agregar
        </button>
      </div>
    </div>

    <!--Lista de detalles -->
    <div class="seccion-detalles">
      <h3 class="titulo-seccion">Detalle de la Venta</h3>
      <div class="contenedor-tabla">
        <table class="tabla-datos texto-centrado">
          <thead>
            <tr>
              <th class="texto-centrado">Producto</th>
              <th class="texto-centrado">Cantidad</th>
              <th class="texto-centrado">Precio Unitario</th>
              <th class="texto-centrado">Subtotal</th>
              <th class="texto-centrado ">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of itemsVenta; let i = index">
              <td>{{ item.nombre }}</td>
              <td class="texto-centrado">{{ item.cantidad }}</td>
              <td class="texto-centrado">${{ item.precio_unitario }}</td>
              <td class="texto-centrado monto-total">${{ item.subtotal }}</td>
              <td class="texto-centrado">
                <button class="boton-eliminar-mini" (click)="eliminarItem(i)" title="Eliminar producto">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="itemsVenta.length === 0">
              <td colspan="5" class="fila-sin-datos">No hay items cargados.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- totales y pagos -->
    <div class="seccion-totales">
      <div class="grupo-formulario">
        <label class="etiqueta-formulario">Método de Pago:</label>
        <select class="campo-formulario" [(ngModel)]="metodoPagoId" (change)="onMetodoPagoChange()">
          <option [ngValue]="null">Seleccionar...</option>
          <option *ngFor="let mp of listaMetodosPago" [value]="mp.id">{{ mp.nombre }}</option>
        </select>
      </div>

      <!-- Boton para QR -->
      <button 
        *ngIf="metodoPagoSeleccionadoNombre.includes('qr')"
        class="btn btn-primary"
        (click)="generarQR()">
        <i class="fas fa-qrcode"></i> Generar QR
      </button>

      <!-- Modal para QR -->
      <div *ngIf="modalQR" class="modal open">
        <div class="modal-content">
          <h3>Escanea para pagar</h3>

          <ng-container *ngIf="qrBase64; else cargandoQR">
            <img [src]="qrBase64" width="250" alt="Código QR de pago" />
            <!-- Mensaje fijo mientras el modal esté abierto -->
            <p style="color: orange; font-weight: bold; margin-top: 10px;">
              <i class="fas fa-sync fa-spin"></i> Esperando pago...
            </p>
            <p style="font-size: 0.8rem; color: #666;">La ventana se cerrará automáticamente al aprobarse.</p>
          </ng-container>

          <ng-template #cargandoQR>
            <p>Conectando con Mercado Pago...</p>
          </ng-template>

          <button class="btn btn-danger" (click)="cerrarModal()">Cancelar / Cerrar</button>
        </div>
      </div>

      <div class="contenedor-total">
        <span class="texto-total">Total a Cobrar:</span>
        <h2 class="monto-total-final">${{ totalCalculado }}</h2>
      </div>
    </div>

    <!-- Botón para confirmar -->
    <div class="contenedor-botones-formulario ancho-completo">
      <button 
        *ngIf="!metodoPagoSeleccionadoNombre.includes('qr')"
        class="boton boton-primario boton-con-icono" 
        (click)="registrarVenta(false)" 
        [disabled]="itemsVenta.length === 0 || !metodoPagoId">
        <i class="fas fa-check"></i> Confirmar Venta
      </button>
    </div>
  </div>
</div>